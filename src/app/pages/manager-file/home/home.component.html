<div class="px-1">
  <!-- Danh sách tệp tin -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl border-2 border-primary">
    <!-- Loading overlay -->
    <div class="relative">
      <div
        class="absolute inset-0 bg-gray-100/75 dark:bg-gray-800/75 flex items-center justify-center z-10"
        *ngIf="loading"
      >
        <div class="flex flex-col items-center">
          <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"
          ></div>
          <span class="mt-2 text-gray-600 dark:text-gray-300">Loading...</span>
        </div>
      </div>

      <!-- Header Section - FIXED -->
      <div class="flex__between px-3 py-2 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 rounded-t-lg">
        <div>
          <h1 class="text-xl font-semibold">
            <ng-container *ngIf="currentMode === 'files'">
              {{ currentFolder ? "Nội dung thư mục" : "Tất cả file" }}
            </ng-container>
            <ng-container *ngIf="currentMode === 'trash'">
              Thùng rác
            </ng-container>
            <ng-container *ngIf="currentMode === 'favorites'">
              File yêu thích
            </ng-container>
          </h1>
          @if(currentMode === 'search'){
          <div class="flex justify-between items-center">
            <span class="text-blue-600">
              <i class="pi pi-search mr-2"></i>
              Kết quả tìm kiếm cho: <strong>"{{ searchTerm }}"</strong>
            </span>
          </div>
          }
        </div>
        <div class="flex items-center gap-2 relative">
          @if(currentMode === 'search'){
          <span class="text-sm text-gray-500">
            Tìm thấy {{ totalRecords }} kết quả
          </span>
          }
          <p-button
            icon="pi pi-ellipsis-v"
            (onClick)="isShowBoxFunction = !isShowBoxFunction"
            [rounded]="true"
            [text]="true"
            severity="secondary"
          />
          <div
            *ngIf="isShowBoxFunction"
            (click)="$event.stopPropagation()"
            (mouseleave)="isShowBoxFunction = false"
            class="absolute right-0 top-10 bg-white dark:bg-gray-800 border border-primary shadow-lg rounded-md w-fit z-20"
          >
            <ul class="list-none p-2 m-0">
              <li
                *ngFor="let item of menuItemFunction"
                (click)="item.action()"
                class="cursor-pointer p-1 px-2 rounded-md whitespace-nowrap transition-colors duration-200"
                [ngClass]="getItemColorClass(item)"
              >
                <i [class]="item.icon" class="mr-2"></i>{{ item.label }}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Table Header - FIXED -->
      <div class="overflow-x-auto bg-gray-50 dark:bg-gray-700">
        <table class="min-w-full">
          <thead>
            <tr>
              <!-- Select all checkbox -->
              <th scope="col" class="w-10 px-3 py-3.5 text-center">
                <div class="flex items-center justify-center">
                  <input
                    type="checkbox"
                    [checked]="areAllFilesSelected()"
                    (change)="toggleSelectAll()"
                    class="h-4 w-4 text-primary rounded border-gray-300 dark:border-gray-600 focus:ring-primary focus:ring-offset-gray-800"
                  />
                </div>
              </th>
              <th scope="col" class="w-12 px-3 py-3.5"></th>
              <th
                scope="col"
                class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white"
              >
                Name
              </th>
              <th
                scope="col"
                class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white w-40"
              >
                Size
              </th>
              <th
                scope="col"
                class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white w-40"
              >
                Type
              </th>
              <th
                scope="col"
                class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white w-40"
              >
                Last Modified
              </th>
              <th
                scope="col"
                class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900 dark:text-white w-40"
              >
                Actions
              </th>
            </tr>
          </thead>
        </table>
      </div>

      <!-- Table Body - SCROLLABLE ONLY HERE -->
      <div
        class="overflow-x-auto overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 max-h-[calc(100vh-340px)] md:max-h-[calc(100vh-290px)]"

      >
        <table class="min-w-full">
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
            <!-- Data rows -->
            <tr
              *ngFor="let file of fileList"
              (dblclick)="handleDoubleClick(file)"
              class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors cursor-pointer"
            >
              <!-- Row checkbox -->
              <td
                class="px-3 py-2.5 whitespace-nowrap text-center w-10"
                (click)="$event.stopPropagation()"
              >
                <div class="flex items-center justify-center">
                  <input
                    type="checkbox"
                    [checked]="isFileSelected(file)"
                    (change)="toggleFileSelection(file)"
                    class="h-4 w-4 text-primary rounded border-gray-300 dark:border-gray-600 focus:ring-primary focus:ring-offset-gray-800"
                  />
                </div>
              </td>
              <td class="px-3 py-2.5 whitespace-nowrap w-12">
                <i
                  [ngClass]="
                    file.type === FileType.Folder
                      ? 'pi pi-folder text-yellow-500'
                      : 'pi pi-file text-blue-500'
                  "
                  class="text-xl"
                ></i>
              </td>
              <td class="px-3 py-2.5 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900 dark:text-white">
                  {{ file.name }}
                </div>
              </td>
              <td class="px-3 py-2.5 whitespace-nowrap w-40">
                <div class="text-sm text-gray-500 dark:text-gray-400">
                  {{ file.type === FileType.Folder ? "-" : file.formattedSize }}
                </div>
              </td>
              <td class="px-3 py-2.5 whitespace-nowrap w-40">
                <div class="text-sm text-gray-500 dark:text-gray-400">
                  {{
                    file.type === FileType.Folder
                      ? "Thư mục"
                      : file.extension || "Tệp tin"
                  }}
                </div>
              </td>
              <td class="px-3 py-2.5 whitespace-nowrap w-40">
                <div class="text-sm text-gray-500 dark:text-gray-400">
                  {{ file.updatedAt | date : "dd/MM/yyyy HH:mm" }}
                </div>
              </td>
              <td class="px-3 py-2.5 whitespace-nowrap text-right w-40">
                <div class="flex gap-1 justify-end">
                  <!-- Files mode actions -->
                  <ng-container
                    *ngIf="currentMode === 'files' || currentMode === 'search'"
                  >
                    <button
                      type="button"
                      class="text-gray-400 hover:text-blue-600 focus:outline-none p-1.5 rounded-full hover:bg-blue-50 transition-colors"
                      (click)="openRenameDialog(file)"
                      title="Đổi tên"
                    >
                      <i class="pi pi-pencil"></i>
                    </button>
                    <button
                      type="button"
                      [ngClass]="
                        file.isFavorite
                          ? 'text-yellow-500 hover:text-yellow-600'
                          : 'text-gray-400 hover:text-yellow-500'
                      "
                      class="focus:outline-none p-1.5 rounded-full hover:bg-yellow-50 transition-colors"
                      (click)="toggleFavorite(file, $event)"
                      title="Yêu thích"
                    >
                      <i
                        [ngClass]="
                          file.isFavorite ? 'pi pi-star-fill' : 'pi pi-star'
                        "
                      ></i>
                    </button>
                    <button
                      type="button"
                      class="text-gray-400 hover:text-red-600 focus:outline-none p-1.5 rounded-full hover:bg-red-50 transition-colors"
                      (click)="confirmDelete(file)"
                      title="Xóa"
                    >
                      <i class="pi pi-trash"></i>
                    </button>
                  </ng-container>

                  <!-- Trash mode actions -->
                  <ng-container *ngIf="currentMode === 'trash'">
                    <button
                      type="button"
                      class="text-gray-400 hover:text-green-600 focus:outline-none p-1.5 rounded-full hover:bg-green-50 transition-colors"
                      (click)="restoreFile(file)"
                      title="Khôi phục"
                    >
                      <i class="pi pi-replay"></i>
                    </button>
                    <button
                      type="button"
                      class="text-gray-400 hover:text-red-600 focus:outline-none p-1.5 rounded-full hover:bg-red-50 transition-colors"
                      (click)="confirmPermanentDelete(file)"
                      title="Xóa vĩnh viễn"
                    >
                      <i class="pi pi-times"></i>
                    </button>
                  </ng-container>

                  <!-- Favorites mode actions -->
                  <ng-container *ngIf="currentMode === 'favorites'">
                    <button
                      type="button"
                      class="text-gray-400 hover:text-blue-600 focus:outline-none p-1.5 rounded-full hover:bg-blue-50 transition-colors"
                      (click)="openRenameDialog(file)"
                      title="Đổi tên"
                    >
                      <i class="pi pi-pencil"></i>
                    </button>
                    <button
                      type="button"
                      class="text-yellow-500 hover:text-yellow-600 focus:outline-none p-1.5 rounded-full hover:bg-yellow-50 transition-colors"
                      (click)="toggleFavorite(file, $event)"
                      title="Bỏ yêu thích"
                    >
                      <i class="pi pi-star-fill"></i>
                    </button>
                    <button
                      type="button"
                      class="text-gray-400 hover:text-red-600 focus:outline-none p-1.5 rounded-full hover:bg-red-50 transition-colors"
                      (click)="confirmDelete(file)"
                      title="Xóa"
                    >
                      <i class="pi pi-trash"></i>
                    </button>
                  </ng-container>
                </div>
              </td>
            </tr>

            <!-- Empty state -->
            <tr *ngIf="fileList.length === 0 && !loading" >
              <td colspan="7" class="px-3 py-10 text-center rounded-b-lg">
                <div class="flex flex-col items-center justify-center">
                  <i class="pi pi-folder-open text-5xl text-gray-300 mb-2"></i>
                  <span class="text-gray-500">
                    <!-- Different messages based on mode -->
                    <ng-container *ngIf="currentMode === 'files'">
                      Không có tệp tin nào trong thư mục này
                    </ng-container>
                    <ng-container *ngIf="currentMode === 'trash'">
                      Thùng rác trống
                    </ng-container>
                    <ng-container *ngIf="currentMode === 'favorites'">
                      Bạn chưa đánh dấu tệp tin nào là yêu thích
                    </ng-container>
                  </span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer/Pagination - FIXED -->
    <div
      class="bg-white dark:bg-gray-800 px-4 py-3 flex items-center justify-between border-t border-gray-200 dark:border-gray-700 sm:px-6 rounded-b-lg"
      *ngIf="shouldPaginate"
    >
      <!-- Thay thế nội dung pagination bằng thiết kế mới -->
      <div class="flex items-center justify-between w-full">
        <!-- Items per page dropdown -->
        <div class="flex items-center space-x-2">
          <span class="text-sm text-gray-700 dark:text-gray-300">Items per page:</span>
          <div class="relative">
            <select
              [ngModel]="pageSize"
              (ngModelChange)="onPageSizeChange($event)"
              class="appearance-none bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-1 px-3 pr-8 rounded-md focus:outline-none focus:ring-primary focus:border-primary cursor-pointer text-sm"
            >
              <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
            </select>

          </div>
        </div>

        <!-- Page info -->
        <div class="text-sm text-gray-700 dark:text-gray-300">
          {{ (currentPage - 1) * pageSize + 1 }} – {{ Math.min(currentPage * pageSize, totalRecords) }} of {{ totalRecords }}
        </div>

        <!-- Navigation buttons -->
        <div class="flex items-center space-x-1">
          <!-- First page -->
          <p-button
           [disabled]="currentPage === 1"
            icon="pi pi-angle-double-left"
            (onClick)="onPageChange({ page: 1})"
            [rounded]="true"
            [text]="true"

            styleClass=" border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
          />

          <!-- Previous page -->
          <p-button
           [disabled]="currentPage === 1"
            icon="pi pi-angle-left"
            (onClick)="onPageChange({ page: currentPage - 1 })"
            [rounded]="true"
            [text]="true"
            styleClass=" border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
          />

          <!-- Next page -->
          <p-button
          [disabled]="currentPage >= getTotalPages()"
            icon="pi pi-angle-right"
            (onClick)="onPageChange({ page: currentPage + 1 })"
            [rounded]="true"
            [text]="true"
            styleClass=" border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
          />

          <!-- Last page -->
           <p-button
           [disabled]="currentPage >= getTotalPages()"
            icon="pi pi-angle-double-right"
            (onClick)="onPageChange({ page: getTotalPages() })"
            [rounded]="true"
            [text]="true"
            styleClass=" border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
          />
        </div>
      </div>
    </div>

    <!-- Hiển thị thông tin khi KHÔNG phân trang -->
    <div
      class="bg-white dark:bg-gray-800 px-4 py-2 border-t border-gray-200 dark:border-gray-700 rounded-b-lg"
      *ngIf="!shouldPaginate && totalRecords > 0"
    >
      <p class="text-sm text-gray-700 dark:text-gray-300 text-center">
        Hiển thị tất cả {{ totalRecords }} items
      </p>
    </div>
  </div>

  <!-- Dialog đổi tên -->
  <p-dialog
    header="Đổi tên"
    [(visible)]="showRenameDialog"
    [modal]="true"
    [style]="{ width: '450px' }"
  >
    <div class="field mb-4">
      <label for="fileName" class="block mb-2">Tên mới</label>
      <input
        id="fileName"
        type="text"
        pInputText
        [(ngModel)]="newFileName"
        class="w-full"
        autofocus
        (keyup.enter)="renameFile()"
      />
    </div>
    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Hủy"
        class="p-button-text"
        (click)="showRenameDialog = false"
      ></button>
      <button pButton type="button" label="Lưu" (click)="renameFile()"></button>
    </ng-template>
  </p-dialog>

  <!-- Dialog xem chi tiết file -->
  <p-dialog
    header="Chi tiết tệp tin"
    [(visible)]="fileDetailDialog"
    [modal]="true"
    [style]="{ width: '70vw', maxWidth: '800px' }"
  >
    <div *ngIf="fileDetail">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <h3 class="text-lg font-medium mb-2">Thông tin cơ bản</h3>
          <div class="mb-2"><strong>Tên:</strong> {{ fileDetail.name }}</div>
          <div class="mb-2">
            <strong>Loại:</strong>
            {{
              fileDetail.type === FileType.Folder
                ? "Thư mục"
                : fileDetail.extension || "Tệp tin"
            }}
          </div>
          <div class="mb-2" *ngIf="fileDetail.type === FileType.File">
            <strong>Kích thước:</strong> {{ fileDetail.formattedSize }}
          </div>
          <div class="mb-2">
            <strong>Ngày tạo:</strong>
            {{ fileDetail.createdAt | date : "dd/MM/yyyy HH:mm" }}
          </div>
          <div class="mb-2">
            <strong>Cập nhật lần cuối:</strong>
            {{ fileDetail.updatedAt | date : "dd/MM/yyyy HH:mm" }}
          </div>
          <div class="mb-2" *ngIf="fileDetail.type === FileType.File">
            <strong>Phiên bản:</strong> {{ fileDetail.version }}
          </div>
        </div>
        <div>
          <h3 class="text-lg font-medium mb-2">Chia sẻ</h3>
          <div *ngIf="fileDetail.isShared">
            <div class="mb-2"><strong>Trạng thái:</strong> Đã chia sẻ</div>
            <div class="mb-2">
              <strong>Mức độ truy cập:</strong>
              {{
                fileDetail.accessLevel === 0
                  ? "Riêng tư"
                  : fileDetail.accessLevel === 1
                  ? "Công khai"
                  : "Chia sẻ với người dùng khác"
              }}
            </div>
          </div>
          <div *ngIf="!fileDetail.isShared">
            <p>Tệp tin này chưa được chia sẻ.</p>
          </div>
        </div>
      </div>

      <div class="mt-4" *ngIf="fileDetail.type === FileType.File">
        <h3 class="text-lg font-medium mb-2">Xem trước</h3>
        <div
          class="border rounded p-4 bg-gray-50 h-64 flex items-center justify-center"
        >
          <!-- Xem trước nội dung file tùy theo loại -->
          <ng-container
            *ngIf="
              fileDetail.extension === '.jpg' ||
              fileDetail.extension === '.jpeg' ||
              fileDetail.extension === '.png' ||
              fileDetail.extension === '.gif'
            "
          >
            <img
              [src]="fileDetail.virtualPath"
              class="max-h-full max-w-full object-contain"
            />
          </ng-container>
          <ng-container *ngIf="fileDetail.extension === '.pdf'">
            <div class="text-center">
              <i class="pi pi-file-pdf text-5xl text-red-500 mb-2"></i>
              <p>Tệp tin PDF</p>
            </div>
          </ng-container>
          <ng-container
            *ngIf="
              fileDetail.extension !== '.jpg' &&
              fileDetail.extension !== '.jpeg' &&
              fileDetail.extension !== '.png' &&
              fileDetail.extension !== '.gif' &&
              fileDetail.extension !== '.pdf'
            "
          >
            <div class="text-center">
              <i class="pi pi-file text-5xl text-blue-500 mb-2"></i>
              <p>Không có bản xem trước cho loại tệp này</p>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Đóng"
        class="p-button-text"
        (click)="fileDetailDialog = false"
      ></button>
      <button
        *ngIf="fileDetail && fileDetail.type === FileType.File"
        pButton
        type="button"
        icon="pi pi-download"
        label="Tải xuống"
        (click)="downloadFile(fileDetail)"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Xác nhận xóa -->
  <p-confirmDialog></p-confirmDialog>

  <!-- Thông báo -->
  <p-toast></p-toast>
</div>
